//= require jquery
//= require jquery_ujs
//= require sibu/common
//= require ../quill/quill
//= require ../cropper/cropper
//= require_self

var Inline = Quill.import('blots/inline');

class IconBlot extends Inline {
    static create(args) {
        let node = super.create();
        node.setAttribute('href', args[0]);
        node.setAttribute('target', '_blank');
        node.setAttribute('class', args[1]);
        return node;
    }

    static formats(node) {
        return node.getAttribute('href');
    }

    format(name, value) {
        if (name !== this.statics.blotName || !value) return super.format(name, value);
        this.domNode.setAttribute('href', value);
    }
}
IconBlot.blotName = 'icon';
IconBlot.tagName = 'a';

Quill.register(IconBlot);
Quill.register(Quill.import('attributors/style/align'), true);

function initQuillEditor(container) {
    var quill = new Quill(container, {
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'], ['link'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['facebook', 'twitter', 'instagram', 'pinterest'],
                ['clean']
            ]
        },
        theme: 'snow'
    });

    function promptWithInit(promptText) {
        var range = quill.getSelection(true);
        if(range && range.length === 0) {
            quill.insertText(range.index, ' ', Quill.sources.USER);
            quill.setSelection(range.index, 1, Quill.sources.USER);
        }
        return prompt(promptText);
    }

    var fbButton = document.querySelector('.ql-facebook');
    fbButton.addEventListener('click', function() {
        var value = promptWithInit('Adresse de la page Facebook :');
        quill.format('icon', [value, 'sb-facebook']);
    });
    var twButton = document.querySelector('.ql-twitter');
    twButton.addEventListener('click', function() {
        var value = promptWithInit('Adresse du compte Twitter :');
        quill.format('icon', [value, 'sb-twitter']);
    });
    var igButton = document.querySelector('.ql-instagram');
    igButton.addEventListener('click', function() {
        var value = promptWithInit('Adresse du compte Instagram :');
        quill.format('icon', [value, 'sb-instagram']);
    });
    var piButton = document.querySelector('.ql-pinterest');
    piButton.addEventListener('click', function() {
        var value = promptWithInit('Adresse du compte Pinterest :');
        quill.format('icon', [value, 'sb-pinterest']);
    });

    return quill;
}

function initCropper(imgId) {
    var wrapper = $(".sibu_crop").first();
    var srcImg = $("#content_panel").find(".sb-editing img[data-id='" + imgId + "']").first();
    var srcContainer = srcImg.parent();
    var ratio = parseFloat(srcContainer.css("width")) / parseFloat(wrapper.css("width"));
    var wrapperHeight = Math.min(320, parseFloat(srcContainer.css("height")) / ratio) + "px";
    wrapper.css("height", wrapperHeight);
    return new Cropper(wrapper.find("img")[0], {
        crop: function(event) {
            var data = event.detail;
            var cropper = this.cropper;
            var imageData = cropper.getImageData();
            var previewWidth = parseFloat(srcContainer.css("width"));
            var imageScaledRatio = data.width / previewWidth;
            var width = imageData.naturalWidth / imageScaledRatio + 'px';
            var height = imageData.naturalHeight / imageScaledRatio + 'px';
            var marginLeft = -data.x / imageScaledRatio + 'px';
            var marginTop = -data.y / imageScaledRatio + 'px';
            // console.log("crop detail : " + JSON.stringify(data));
            // console.log('img data : ' + JSON.stringify(imageData));
            $("#element_style").val("width: " + width + "; height: " + height + "; margin-left: " + marginLeft + "; margin-top: " + marginTop +"; max-width: none; max-height: none;");
        }
    });
}

function refreshAfterEdit(sectionId) {
    var baseUrl = window.location.href.split('?')[0];
    if (sectionId) {
        window.location.href = baseUrl + '?edit_section=' + sectionId;
    } else {
        window.location.href = baseUrl;
    }
}